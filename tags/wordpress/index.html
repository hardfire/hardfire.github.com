    <!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  
  <title>Tag: wordpress | Avinash&#39;s Blog</title>

	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
  <link rel="me" href="mailto:avinash@avinash.com.np" />
  <link rel="stylesheet" href="/styles/bootstrap.min.css">
  <link rel="stylesheet" href="/styles/bootstrap-responsive.min.css">
  <link rel="stylesheet" href="/styles/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-36082124-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>

    <footer>
  <div class="row">
    <div class="span7 offset1">
      <a href="/">Home</a><a href="/about/">About</a><a href="https://bm.avinash.com.np">Stream</a>
    </div>
  </div>
</footer>

      <div class="row">
        <div class="span7 offset1">
          
  <ul class="post-list expanded unstyled">
  
  
  
      
      
        <li>
          <div class="meta">
            <div class="title">  <a href="/2017/12/31/AMP-Wordpress-and-amp-form.html">AMP, WordPress and amp-form</a></div>
            <div>2017 Dec </div>
          </div>
          <div class="content">
            <p>Now that google is pushing AMP a lot, it has been one of the better ways to attract some organic traffic.  In one of my recent projects we had to setup a signup form on the AMP pages. We use <code>AMP for WP</code> (a very well done plugin btw) but wanted to try adding the form ourselves, instead of purchasing one of their paid plugins (Which would be the easier way, but one must get their hands dirty to understand).</p>
<p>The whole thing can be broken down into the following steps</p>
<ul>
<li>Setup</li>
<li>Render the form</li>
<li>Process the form</li>
<li>Fun and Profit</li>
</ul>
<h3 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h3><p>To use amp-form we should add the following JavaScript file in the <code>head</code><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">async</span> <span class="attr">custom-element</span>=<span class="string">"amp-form"</span> <span class="attr">src</span>=<span class="string">"https://cdn.ampproject.org/v0/amp-form-0.1.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Render-the-form"><a href="#Render-the-form" class="headerlink" title="Render the form"></a>Render the form</h3><p>Since we already use the <code>ampforwp</code> plugin and we want to render a form after every article, we hook into the <code>ampforwp_after_post_content</code> action. I did try adding html into a widget, but it never got rendered for some reason. I still have to get into why it happened. But then, I had a problem to solve.</p>
<p>Add something like this to your <code>functions.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">namespace_add_amp_form</span><span class="params">($amp_template)</span> </span>&#123;</span><br><span class="line">  $post_url = admin_url(<span class="string">'admin-ajax.php?action=amp_form_submit'</span>);</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'&lt;form name="amp-form" class="hide-inputs" method="post" action-xhr="'</span>.$post_url.<span class="string">'" target="_top"&gt;</span></span><br><span class="line"><span class="string">    &lt;input type="email" name="email" placeholder="email" required&gt;</span></span><br><span class="line"><span class="string">    &lt;input type="submit" value="Make me Famous" /&gt;</span></span><br><span class="line"><span class="string">    &lt;div submit-success&gt; Yep, you will be famous!! soon. &lt;/div&gt;</span></span><br><span class="line"><span class="string">  &lt;/form&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line">add_action(<span class="string">'ampforwp_after_post_content'</span>, <span class="string">'namespace_add_amp_form'</span>);</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="Process-the-form"><a href="#Process-the-form" class="headerlink" title="Process the form"></a>Process the form</h3><p>Most of the form processing is straightforward. The only complication is that <code>amp</code> does some magic which requires us to handle cross origin requests and respond in a manner so that they can accept and process the response. <a href="https://github.com/ampproject/amphtml/blob/master/spec/amp-cors-requests.md" target="_blank" rel="noopener">More details here</a></p>
<p>I didn’t handle all the cases, but what we have below is a version that accepts the form submission and our frontend handles it perfectly.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">namespace_handle_amp_form_submit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'__amp_source_origin'</span>]) || $_GET[<span class="string">'__amp_source_origin'</span>] != <span class="string">"https://avinash.com.np"</span>)</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line"></span><br><span class="line">  header(<span class="string">"Access-Control-Allow-Credentials: true"</span>);</span><br><span class="line">  header(<span class="string">"AMP-Access-Control-Allow-Source-Origin: https://avinash.com.np"</span>);</span><br><span class="line">  header(<span class="string">"Access-Control-Allow-Origin: https://avinash-com-np.cdn.ampproject.org"</span>);</span><br><span class="line">  header(<span class="string">"Access-Control-Expose-Headers: AMP-Access-Control-Allow-Source-Origin"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// handle the form submission here</span></span><br><span class="line">  handle_form_submission()</span><br><span class="line">&#125;</span><br><span class="line">add_action(<span class="string">"wp_ajax_amp_form_submit"</span>, <span class="string">"namespace_handle_amp_form_submit"</span>);</span><br><span class="line">add_action(<span class="string">"wp_ajax_nopriv_amp_form_submit"</span>, <span class="string">"namespace_handle_amp_form_submit"</span>);</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="Fun-and-Profit"><a href="#Fun-and-Profit" class="headerlink" title="Fun and Profit"></a>Fun and Profit</h3><p>Once this works, I’m pretty sure it will be fun. Profit, well, lets hope google’s organic traffic should bring some profit as well :D</p>
<p>If everything is not clear, please read about <a href="https://codex.wordpress.org/AJAX_in_Plugins" target="_blank" rel="noopener">AJAX in WordPress</a> and <a href="https://www.ampproject.org/docs/reference/components/amp-form" target="_blank" rel="noopener">amp-form</a>. In case you’re still stuck, please reach out to me and I’d be more than happy to help (for fun and profit).</p>

          </div>
        </li>
      
  
  </ul>



        </div>
      </div>
  </body>
</html>
